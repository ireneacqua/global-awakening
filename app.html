<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Awakening Platform</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .ripple { animation: ripple 2s ease-out infinite; }
        
        .bg-gradient { background: linear-gradient(135deg, #312e81 0%, #7c3aed 50%, #db2777 100%); }
        .bg-glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); }
        .bg-glass-dark { background: rgba(255, 255, 255, 0.05); }
        .border-glass { border: 1px solid rgba(255, 255, 255, 0.2); }
        .text-primary { color: #a78bfa; }
        .text-secondary { color: #e9d5ff; }
        
        .btn-primary {
            background: linear-gradient(90deg, #7c3aed 0%, #db2777 50%, #ea580c 100%);
            color: #fff;
            font-weight: 800;
            padding: 1rem 2rem;
            border-radius: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.05rem;
            letter-spacing: 0.03em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 20px 40px rgba(139, 92, 246, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(30, 20, 60, 0.7);
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.35);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            letter-spacing: 0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        }
        .btn-secondary:hover { background: rgba(30, 20, 60, 0.85); }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        
        .w-full { width: 100%; }
        .min-h-screen { min-height: 100vh; }
        .max-w-md { max-width: 28rem; }
        
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .border-b { border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .border-t { border-top: 1px solid rgba(255, 255, 255, 0.2); }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .text-6xl { font-size: 3.75rem; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-white { color: white; }
        
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1rem;
        }
        input::placeholder, textarea::placeholder { color: rgba(255, 255, 255, 0.5); }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #a78bfa; }
        
        .fixed { position: fixed; }
        .sticky { position: sticky; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .top-0 { top: 0; }
        .top-4 { top: 1rem; }
        .right-4 { right: 1rem; }
        .left-0 { left: 0; }
        .bottom-0 { bottom: 0; }
        .z-50 { z-index: 50; }
        
        .overflow-y-auto { overflow-y: auto; }
        .flex-1 { flex: 1; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .transition-all { transition: all 0.3s; }
        
        .tab-active {
            background: rgba(20, 10, 50, 0.8);
            color: #fff;
            font-weight: 700;
            font-size: 1.05rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .tab-inactive {
            color: #fff;
            font-weight: 600;
            font-size: 1.05rem;
            background: rgba(30, 20, 60, 0.5);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        .tab-inactive:hover { background: rgba(30, 20, 60, 0.7); }
        
        .symbol-btn {
            font-size: 3.75rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .symbol-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .symbol-btn-selected {
            background: rgba(139, 92, 246, 0.5);
            border-color: #a78bfa;
            transform: scale(1.1);
        }
        
        .result-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        .result-try-again {
            background: rgba(251, 146, 60, 0.2);
            border: 1px solid rgba(251, 146, 60, 0.5);
        }
        
        .chat-container { height: 600px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; }
        .chat-message {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .online-dot {
            width: 0.75rem;
            height: 0.75rem;
            background: #4ade80;
            border-radius: 50%;
        }
        
        .ritual-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        .ritual-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .ritual-live {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));
            border-color: #4ade80;
        }
        
        .map-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            overflow: hidden;
        }
        
        .map-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fbbf24;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }
        
        .map-point:hover {
            transform: translate(-50%, -50%) scale(1.5);
        }
        
        .map-ripple {
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #fbbf24;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(49, 46, 129, 0.95), rgba(124, 58, 237, 0.95));
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @media (max-width: 768px) {
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .text-4xl { font-size: 2rem; }
            .text-3xl { font-size: 1.5rem; }
            .text-2xl { font-size: 1.25rem; }
            .symbol-btn { font-size: 3rem; padding: 1rem; }
            .map-container { height: 400px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(
            'https://vxzxdkcluyrcftsnxxza.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4enhka2NsdXlyY2Z0c254eHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg0MTQwOTUsImV4cCI6MjA1Mzk5MDA5NX0.sb_publishable_AzwgfHpTfTDzi5n6fgFUDA_Qba_KX42'
        );

        const Star = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
        const Brain = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg>;
        const Send = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const Calendar = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const Users = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;

        const telepathySymbols = [
          { id: 'star', icon: '‚≠ê', name: 'Star' },
          { id: 'sun', icon: '‚òÄÔ∏è', name: 'Sun' },
          { id: 'moon', icon: 'üåô', name: 'Moon' },
          { id: 'heart', icon: 'üíú', name: 'Heart' },
          { id: 'eye', icon: 'üëÅÔ∏è', name: 'Eye' },
          { id: 'infinity', icon: '‚àû', name: 'Infinity' }
        ];

        const ritualTypes = [
          { id: 'consciousness', name: 'Consciousness Elevation', icon: 'üß†' },
          { id: 'dna', name: 'DNA Activation', icon: 'üß¨' },
          { id: 'lightbody', name: 'Light Body Activation', icon: '‚ú®' },
          { id: 'unity', name: 'Unity Consciousness', icon: 'ü§ù' },
          { id: 'ascension', name: 'Ascension Portal', icon: 'üåÖ' }
        ];

        const sacredNumbers = [1, 3, 7, 9, 11, 22, 33, 44, 108];

        const translations = {
          en: {
            title: "Global Awakening",
            subtitle: "Unite in Light, Awaken as One",
            enterPlatform: "Enter Platform",
            tabs: { rituals: "Rituals", telepathy: "Telepathy", chat: "Chat", map: "Map" },
            rituals: {
              title: "Global Rituals",
              subtitle: "Synchronized awakening ceremonies",
              createRitual: "Propose Ritual",
              noRituals: "No rituals yet. Be the first to propose one!",
              participants: "participants",
              startsIn: "Starts in",
              live: "LIVE NOW",
              ended: "Ended",
              join: "Join",
              joined: "Joined",
              sendEnergy: "Send Energy",
              modalTitle: "Create Ritual",
              ritualName: "Ritual Name",
              description: "Description",
              type: "Type",
              sacredNumber: "Sacred Number",
              date: "Date",
              time: "Time (UTC)",
              duration: "Duration (minutes)",
              create: "Create Ritual",
              cancel: "Cancel"
            },
            map: {
              title: "Global Network",
              subtitle: "Starseeds awakening together",
              visible: "visible starseeds"
            }
          },
          it: {
            title: "Risveglio Globale",
            subtitle: "Uniti nella Luce, Risvegliati come Uno",
            enterPlatform: "Entra",
            tabs: { rituals: "Rituali", telepathy: "Telepatia", chat: "Chat", map: "Mappa" },
            rituals: {
              title: "Rituali Globali",
              subtitle: "Cerimonie di risveglio sincronizzate",
              createRitual: "Proponi Rituale",
              noRituals: "Nessun rituale ancora. Sii il primo a proporne uno!",
              participants: "partecipanti",
              startsIn: "Inizia tra",
              live: "IN DIRETTA",
              ended: "Terminato",
              join: "Unisciti",
              joined: "Unito",
              sendEnergy: "Invia Energia",
              modalTitle: "Crea Rituale",
              ritualName: "Nome Rituale",
              description: "Descrizione",
              type: "Tipo",
              sacredNumber: "Numero Sacro",
              date: "Data",
              time: "Ora (UTC)",
              duration: "Durata (minuti)",
              create: "Crea Rituale",
              cancel: "Annulla"
            },
            map: {
              title: "Rete Globale",
              subtitle: "Starseeds che si risvegliano insieme",
              visible: "starseeds visibili"
            }
          }
        };

        function GlobalAwakeningPlatform() {
          const [lang, setLang] = useState('en');
          const [activeTab, setActiveTab] = useState('rituals');
          const [nickname, setNickname] = useState('');
          const [tempNickname, setTempNickname] = useState('');
          const [showNicknamePrompt, setShowNicknamePrompt] = useState(true);
          const [onlineUsers, setOnlineUsers] = useState([]);
          
          const [telepathyScore, setTelepathyScore] = useState(0);
          const [bestScore, setBestScore] = useState(0);
          const [searchingPartner, setSearchingPartner] = useState(false);
          const [partner, setPartner] = useState(null);
          const [role, setRole] = useState(null);
          const [selectedSymbol, setSelectedSymbol] = useState(null);
          const [guessedSymbol, setGuessedSymbol] = useState(null);
          const [waitingForPartner, setWaitingForPartner] = useState(false);
          const [showResult, setShowResult] = useState(false);
          const [isMatch, setIsMatch] = useState(false);
          
          const [chatMessages, setChatMessages] = useState([]);
          const [newMessage, setNewMessage] = useState('');
          
          const [rituals, setRituals] = useState([]);
          const [showCreateRitual, setShowCreateRitual] = useState(false);
          const [newRitual, setNewRitual] = useState({
            name: '',
            description: '',
            type: 'consciousness',
            sacredNumber: 11,
            date: '',
            time: '',
            duration: 30
          });
          
          const sessionId = useRef(Date.now() + '-' + Math.random());
          const t = translations[lang];

          // Load scores
          useEffect(() => {
            const score = localStorage.getItem('telepathy_score');
            const best = localStorage.getItem('telepathy_best');
            if (score) setTelepathyScore(parseInt(score));
            if (best) setBestScore(parseInt(best));
          }, []);

          // Update presence in Supabase
          useEffect(() => {
            if (!nickname) return;

            const myLat = 20 + Math.random() * 50;
            const myLng = -120 + Math.random() * 200;

            const updatePresence = async () => {
              try {
                const { error: upsertError } = await supabase.from('online_users').upsert({
                  id: sessionId.current,
                  nickname: nickname || 'Anonymous',
                  lat: myLat,
                  lng: myLng,
                  last_seen: new Date().toISOString()
                });

                if (upsertError) console.warn('Presence upsert error:', upsertError);

                // Clean old users
                await supabase.from('online_users').delete().lt('last_seen', new Date(Date.now() - 60000).toISOString());

                // Fetch current online users
                const { data, error: fetchError } = await supabase.from('online_users').select('*');
                if (fetchError) {
                  console.warn('Fetch online users error:', fetchError);
                  // Fallback: at least show yourself
                  setOnlineUsers([{ id: sessionId.current, nickname, lat: myLat, lng: myLng }]);
                } else {
                  setOnlineUsers(data && data.length > 0 ? data : [{ id: sessionId.current, nickname, lat: myLat, lng: myLng }]);
                }
              } catch (err) {
                console.warn('Presence update failed:', err);
                setOnlineUsers([{ id: sessionId.current, nickname, lat: myLat, lng: myLng }]);
              }
            };

            updatePresence();
            const interval = setInterval(updatePresence, 10000);
            return () => {
              clearInterval(interval);
              supabase.from('online_users').delete().eq('id', sessionId.current);
            };
          }, [nickname]);

          // Load data from Supabase
          useEffect(() => {
            const loadData = async () => {
              const { data: messages } = await supabase.from('chat_messages').select('*').order('created_at', { ascending: true }).limit(50);
              if (messages) setChatMessages(messages);
              
              const { data: ritualsData } = await supabase.from('rituals').select('*').order('created_at', { ascending: false });
              if (ritualsData) setRituals(ritualsData);
            };
            
            loadData();
            const interval = setInterval(loadData, 3000);
            
            // Subscribe to real-time updates
            const ritualsChannel = supabase.channel('rituals-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'rituals' }, () => loadData()).subscribe();
            const chatChannel = supabase.channel('chat-channel').on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, () => loadData()).subscribe();
            
            return () => {
              clearInterval(interval);
              ritualsChannel.unsubscribe();
              chatChannel.unsubscribe();
            };
          }, []);

          // Telepathy matching
          useEffect(() => {
            if (!searchingPartner) return;

            const findPartner = async () => {
              // Clean old entries
              await supabase.from('telepathy_queue').delete().lt('timestamp', Date.now() - 60000);
              
              // Get all waiting people
              const { data: queue } = await supabase.from('telepathy_queue').select('*').neq('id', sessionId.current).order('timestamp', { ascending: true });
              
              if (queue && queue.length > 0) {
                // Match with first person in queue
                const available = queue[0];
                setPartner(available);
                setRole(Math.random() > 0.5 ? 'sender' : 'receiver');
                setSearchingPartner(false);
                
                // Remove both from queue
                await supabase.from('telepathy_queue').delete().eq('id', sessionId.current);
                await supabase.from('telepathy_queue').delete().eq('id', available.id);
              } else {
                // Add self to queue
                await supabase.from('telepathy_queue').upsert({
                  id: sessionId.current,
                  nickname: nickname || 'Anonymous',
                  timestamp: Date.now()
                });
              }
            };

            findPartner();
            const interval = setInterval(findPartner, 2000);
            return () => {
              clearInterval(interval);
              // Remove from queue when stopping search
              if (searchingPartner) {
                supabase.from('telepathy_queue').delete().eq('id', sessionId.current);
              }
            };
          }, [searchingPartner, nickname]);
          
          // Show queue position
          const [queuePosition, setQueuePosition] = useState(0);
          const [queueSize, setQueueSize] = useState(0);
          
          useEffect(() => {
            if (!searchingPartner) return;
            
            const checkQueue = async () => {
              const { data: queue } = await supabase.from('telepathy_queue').select('*').order('timestamp', { ascending: true });
              if (queue) {
                setQueueSize(queue.length);
                const myPosition = queue.findIndex(q => q.id === sessionId.current);
                setQueuePosition(myPosition >= 0 ? myPosition + 1 : 0);
              }
            };
            
            checkQueue();
            const interval = setInterval(checkQueue, 1000);
            return () => clearInterval(interval);
          }, [searchingPartner]);

          const handleEnter = () => {
            setNickname(tempNickname || 'Anonymous');
            setShowNicknamePrompt(false);
          };

          const startSearching = () => {
            setSearchingPartner(true);
            setPartner(null);
            setRole(null);
            setSelectedSymbol(null);
            setGuessedSymbol(null);
            setShowResult(false);
          };

          const sendSymbol = () => {
            if (!selectedSymbol) return;
            setWaitingForPartner(true);
            
            setTimeout(() => {
              const partnerGuess = telepathySymbols[Math.floor(Math.random() * telepathySymbols.length)].id;
              const match = partnerGuess === selectedSymbol;
              setIsMatch(match);
              setShowResult(true);
              setWaitingForPartner(false);
              
              if (match) {
                const newScore = telepathyScore + 10;
                setTelepathyScore(newScore);
                localStorage.setItem('telepathy_score', newScore);
                if (newScore > bestScore) {
                  setBestScore(newScore);
                  localStorage.setItem('telepathy_best', newScore);
                }
              }
            }, 2000);
          };

          const submitGuess = () => {
            if (!guessedSymbol) return;
            setWaitingForPartner(true);
            
            setTimeout(() => {
              const senderSymbol = telepathySymbols[Math.floor(Math.random() * telepathySymbols.length)].id;
              const match = guessedSymbol === senderSymbol;
              setIsMatch(match);
              setShowResult(true);
              setWaitingForPartner(false);
              
              if (match) {
                const newScore = telepathyScore + 10;
                setTelepathyScore(newScore);
                localStorage.setItem('telepathy_score', newScore);
                if (newScore > bestScore) {
                  setBestScore(newScore);
                  localStorage.setItem('telepathy_best', newScore);
                }
              }
            }, 2000);
          };

          const resetTelepathy = () => {
            setPartner(null);
            setRole(null);
            setSelectedSymbol(null);
            setGuessedSymbol(null);
            setShowResult(false);
            setWaitingForPartner(false);
          };

          const sendChatMessage = async () => {
            if (!newMessage.trim()) return;
            
            await supabase.from('chat_messages').insert({
              user_name: nickname || 'Anonymous',
              content: newMessage
            });
            
            setNewMessage('');
          };

          const createRitual = async () => {
            if (!newRitual.name || !newRitual.date || !newRitual.time) {
              alert('Please fill in name, date and time.');
              return;
            }

            const ritualData = {
              creator: nickname || 'Anonymous',
              creator_id: sessionId.current,
              name: newRitual.name,
              description: newRitual.description,
              type: newRitual.type,
              sacred_number: newRitual.sacredNumber,
              date: newRitual.date,
              time: newRitual.time,
              duration: newRitual.duration,
              participants: [sessionId.current],
              energy: 0
            };

            try {
              const { data, error } = await supabase.from('rituals').insert(ritualData).select();

              if (error) {
                console.warn('Supabase insert error:', error);
                // Fallback: add locally so the user sees it
                const localRitual = { ...ritualData, id: 'local-' + Date.now(), created_at: new Date().toISOString() };
                setRituals(prev => [localRitual, ...prev]);
              }
            } catch (err) {
              console.warn('Create ritual failed:', err);
              const localRitual = { ...ritualData, id: 'local-' + Date.now(), created_at: new Date().toISOString() };
              setRituals(prev => [localRitual, ...prev]);
            }

            setShowCreateRitual(false);
            setNewRitual({
              name: '',
              description: '',
              type: 'consciousness',
              sacredNumber: 11,
              date: '',
              time: '',
              duration: 30
            });
          };

          const joinRitual = async (ritualId) => {
            const ritual = rituals.find(r => r.id === ritualId);
            if (!ritual || ritual.participants.includes(sessionId.current)) return;
            
            await supabase.from('rituals').update({
              participants: [...ritual.participants, sessionId.current]
            }).eq('id', ritualId);
          };

          const sendEnergy = async (ritualId) => {
            const ritual = rituals.find(r => r.id === ritualId);
            if (!ritual) return;
            
            await supabase.from('rituals').update({
              energy: ritual.energy + 10
            }).eq('id', ritualId);
          };

          const getRitualStatus = (ritual) => {
            const now = new Date();
            const ritualTime = new Date(`${ritual.date}T${ritual.time}Z`);
            const endTime = new Date(ritualTime.getTime() + ritual.duration * 60000);
            
            if (now >= ritualTime && now <= endTime) return 'live';
            if (now > endTime) return 'ended';
            
            const diff = ritualTime - now;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
          };

          if (showNicknamePrompt) {
            return (
              <div className="min-h-screen bg-gradient flex items-center justify-center p-4">
                <div className="absolute top-4 right-4">
                  <button onClick={() => setLang(lang === 'en' ? 'it' : 'en')} className="btn-secondary">
                    {lang === 'en' ? 'IT' : 'EN'}
                  </button>
                </div>
                
                <div className="bg-glass rounded-3xl p-8 max-w-md w-full shadow-2xl border-glass">
                  <div className="text-center mb-8">
                    <div style={{fontSize: '4rem'}} className="mb-4 pulse-glow">‚≠ê</div>
                    <h1 className="text-4xl font-bold text-white mb-2">{t.title}</h1>
                    <p className="text-secondary text-sm">{t.subtitle}</p>
                  </div>

                  <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                    <input
                      type="text"
                      value={tempNickname}
                      onChange={(e) => setTempNickname(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleEnter()}
                      placeholder="Choose nickname (optional)..."
                    />
                    <button onClick={handleEnter} className="btn-primary" style={{width: '100%', fontSize: '1.125rem'}}>
                      {t.enterPlatform}
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient">
              <header className="sticky top-0 bg-glass border-b z-50">
                <div className="container">
                  <div className="flex items-center justify-between py-3">
                    <div className="flex items-center gap-3">
                      <Star style={{width: '2rem', height: '2rem', color: '#fbbf24'}} />
                      <div>
                        <h1 className="text-xl font-bold text-white">{t.title}</h1>
                        <p className="text-primary text-xs">{t.subtitle}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <button onClick={() => setLang(lang === 'en' ? 'it' : 'en')} className="btn-secondary px-3 py-2">
                        {lang === 'en' ? 'IT' : 'EN'}
                      </button>
                      <div className="text-white font-medium">{nickname}</div>
                    </div>
                  </div>
                </div>
              </header>

              <div className="container py-3">
                <div className="bg-glass rounded-2xl p-4 border-glass" style={{background: 'linear-gradient(90deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2), rgba(251, 191, 36, 0.2))'}}>
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div>
                      <div className="text-2xl font-bold text-white">{rituals.length}</div>
                      <div className="text-secondary text-xs">Active Rituals</div>
                    </div>
                    <div>
                      <div className="text-2xl font-bold" style={{color: '#fbbf24'}}>{telepathyScore}</div>
                      <div className="text-secondary text-xs">Telepathy Score</div>
                    </div>
                    <div>
                      <div className="text-2xl font-bold" style={{color: '#4ade80'}}>{onlineUsers.length}</div>
                      <div className="text-secondary text-xs">Online Now</div>
                    </div>
                  </div>
                </div>
              </div>

              <div className="container" style={{paddingTop: '0.5rem'}}>
                <div className="flex gap-2 bg-glass rounded-2xl p-3" style={{overflowX: 'auto'}}>
                  {['rituals', 'telepathy', 'map', 'chat'].map((tab) => (
                    <button
                      key={tab}
                      onClick={() => setActiveTab(tab)}
                      className={`py-2 px-4 rounded-xl font-medium transition-all ${
                        activeTab === tab ? 'tab-active' : 'tab-inactive'
                      }`}
                      style={{whiteSpace: 'nowrap', flex: '0 0 auto'}}
                    >
                      {t.tabs[tab]}
                    </button>
                  ))}
                </div>
              </div>

              <div className="container py-6">
                {activeTab === 'rituals' && (
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h2 className="text-3xl font-bold text-white mb-2">{t.rituals.title}</h2>
                        <p className="text-primary">{t.rituals.subtitle}</p>
                      </div>
                      <button onClick={() => setShowCreateRitual(true)} className="btn-primary">
                        {t.rituals.createRitual}
                      </button>
                    </div>

                    {rituals.length === 0 && (
                      <div className="bg-glass rounded-2xl p-12 text-center border-glass">
                        <div style={{fontSize: '4rem'}} className="mb-4">üåü</div>
                        <p className="text-white">{t.rituals.noRituals}</p>
                      </div>
                    )}

                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem'}}>
                      {rituals.map(ritual => {
                        const status = getRitualStatus(ritual);
                        const isLive = status === 'live';
                        const isJoined = ritual.participants.includes(sessionId.current);
                        
                        return (
                          <div key={ritual.id} className={`ritual-card ${isLive ? 'ritual-live' : ''}`}>
                            <div className="flex items-start justify-between mb-3">
                              <div>
                                <div style={{fontSize: '2rem'}} className="mb-2">{ritualTypes.find(t => t.id === ritual.type)?.icon}</div>
                                <h3 className="text-xl font-bold text-white mb-1">{ritual.name}</h3>
                                <p className="text-secondary text-sm">{ritual.description}</p>
                              </div>
                              <div className="text-2xl" style={{color: '#fbbf24'}}>{ritual.sacred_number}</div>
                            </div>

                            <div className="flex items-center gap-2 mb-3">
                              <Calendar style={{width: '1rem', height: '1rem', color: '#a78bfa'}} />
                              <span className="text-primary text-sm">{ritual.date} {ritual.time} UTC</span>
                            </div>

                            <div className="flex items-center justify-between mb-4">
                              <div className="flex items-center gap-2">
                                <Users style={{width: '1rem', height: '1rem', color: '#a78bfa'}} />
                                <span className="text-white text-sm">{ritual.participants.length} {t.rituals.participants}</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className="text-sm" style={{color: isLive ? '#4ade80' : '#fbbf24'}}>
                                  {isLive ? t.rituals.live : (status === 'ended' ? t.rituals.ended : `${t.rituals.startsIn} ${status}`)}
                                </span>
                              </div>
                            </div>

                            <div className="flex gap-2">
                              <button
                                onClick={() => joinRitual(ritual.id)}
                                className={isJoined ? 'btn-secondary flex-1' : 'btn-primary flex-1'}
                                disabled={isJoined || status === 'ended'}
                              >
                                {isJoined ? t.rituals.joined : t.rituals.join}
                              </button>
                              {isLive && (
                                <button onClick={() => sendEnergy(ritual.id)} className="btn-secondary px-4">
                                  ‚ö° {ritual.energy}
                                </button>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {activeTab === 'map' && (
                  <div>
                    <div className="mb-6">
                      <h2 className="text-3xl font-bold text-white mb-2">{t.map.title}</h2>
                      <p className="text-primary">{t.map.subtitle}</p>
                    </div>

                    <div className="map-container">
                      <img 
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 500'%3E%3Crect fill='%23111827' width='1000' height='500'/%3E%3Cpath fill='%231f2937' d='M0 250 Q 250 200 500 250 T 1000 250 L 1000 500 L 0 500 Z'/%3E%3C/svg%3E"
                        alt="World map"
                        style={{width: '100%', height: '100%', objectFit: 'cover'}}
                      />
                      {onlineUsers.map(user => {
                        const x = ((user.lng + 180) / 360) * 100;
                        const y = ((90 - user.lat) / 180) * 100;
                        
                        return (
                          <React.Fragment key={user.id}>
                            <div 
                              className="map-point"
                              style={{left: `${x}%`, top: `${y}%`}}
                              title={user.nickname}
                            />
                            <div 
                              className="map-ripple ripple"
                              style={{left: `${x}%`, top: `${y}%`}}
                            />
                          </React.Fragment>
                        );
                      })}
                    </div>

                    <div className="mt-4 text-center">
                      <span className="text-white text-lg font-bold">{onlineUsers.length}</span>
                      <span className="text-primary ml-2">{t.map.visible}</span>
                    </div>
                  </div>
                )}

                {activeTab === 'telepathy' && (
                  <div className="bg-glass rounded-2xl p-6 border-glass">
                    <div className="text-center mb-6">
                      <Brain style={{width: '4rem', height: '4rem', margin: '0 auto 1rem', color: '#a78bfa'}} />
                      <h2 className="text-3xl font-bold text-white mb-2">Telepathy Training</h2>
                      <p className="text-primary">Develop your psychic abilities</p>
                    </div>

                    {!partner && !searchingPartner && (
                      <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                        <div className="bg-glass-dark rounded-xl p-6" style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                          <h3 className="text-white font-bold mb-3">How it works:</h3>
                          <p className="text-primary text-sm">1. Click 'Find Partner' to connect</p>
                          <p className="text-primary text-sm">2. One sends a symbol, one receives</p>
                          <p className="text-primary text-sm">3. Match correctly to earn points!</p>
                        </div>
                        <button onClick={startSearching} className="btn-primary w-full" style={{fontSize: '1.125rem'}}>
                          Find Partner
                        </button>
                      </div>
                    )}

                    {searchingPartner && (
                      <div className="text-center" style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                        <div style={{fontSize: '4rem'}} className="pulse-glow">üîÆ</div>
                        <p className="text-white text-xl">Searching for partner...</p>
                        {queueSize > 1 && (
                          <div className="bg-glass-dark rounded-xl p-4">
                            <p className="text-primary">Queue position: <span className="text-white font-bold">{queuePosition}</span> / {queueSize}</p>
                            <p className="text-secondary text-sm mt-2">{queueSize - 1} starseed{queueSize > 2 ? 's' : ''} waiting</p>
                          </div>
                        )}
                        <button onClick={() => setSearchingPartner(false)} className="btn-secondary">Cancel</button>
                      </div>
                    )}

                    {partner && !showResult && (
                      <div style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                        <div className="result-success rounded-xl p-4 text-center">
                          <p style={{color: '#4ade80'}} className="font-bold">‚ú® Partner found!</p>
                          <p className="text-white mt-2">
                            Training with: <span className="font-bold text-yellow-300">{partner.nickname}</span>
                          </p>
                          <p className="text-secondary text-sm mt-1">Your role: <span className="font-bold text-white">{role === 'sender' ? 'SENDER' : 'RECEIVER'}</span></p>
                        </div>

                        {role === 'sender' && !waitingForPartner && (
                          <div>
                            <p className="text-white text-center mb-4 font-medium">Select a symbol to send:</p>
                            <div className="grid grid-cols-3 gap-4 mb-6">
                              {telepathySymbols.map((symbol) => (
                                <button
                                  key={symbol.id}
                                  onClick={() => setSelectedSymbol(symbol.id)}
                                  className={`symbol-btn ${selectedSymbol === symbol.id ? 'symbol-btn-selected' : ''}`}
                                >
                                  {symbol.icon}
                                </button>
                              ))}
                            </div>
                            <button onClick={sendSymbol} disabled={!selectedSymbol} className="btn-primary w-full">
                              Send Telepathically
                            </button>
                          </div>
                        )}

                        {role === 'receiver' && !waitingForPartner && (
                          <div>
                            <p className="text-white text-center mb-4 font-medium">Which symbol do you receive?</p>
                            <div className="grid grid-cols-3 gap-4 mb-6">
                              {telepathySymbols.map((symbol) => (
                                <button
                                  key={symbol.id}
                                  onClick={() => setGuessedSymbol(symbol.id)}
                                  className={`symbol-btn ${guessedSymbol === symbol.id ? 'symbol-btn-selected' : ''}`}
                                >
                                  {symbol.icon}
                                </button>
                              ))}
                            </div>
                            <button onClick={submitGuess} disabled={!guessedSymbol} className="btn-primary w-full">
                              Submit
                            </button>
                          </div>
                        )}

                        {waitingForPartner && (
                          <div className="text-center">
                            <div style={{fontSize: '4rem'}} className="pulse-glow mb-4">üîÆ</div>
                            <p className="text-primary">Processing telepathic transmission...</p>
                          </div>
                        )}
                      </div>
                    )}

                    {showResult && (
                      <div style={{display: 'flex', flexDirection: 'column', gap: '1.5rem'}}>
                        <div className={`${isMatch ? 'result-success' : 'result-try-again'} rounded-xl p-6 text-center`}>
                          <div style={{fontSize: '4rem'}} className="mb-4">{isMatch ? '‚ú®' : 'üåü'}</div>
                          <h3 className="text-2xl font-bold mb-2" style={{color: isMatch ? '#4ade80' : '#fb923c'}}>
                            {isMatch ? '‚ú® TELEPATHIC MATCH! ‚ú®' : 'Not this time. Keep practicing!'}
                          </h3>
                          {isMatch && (
                            <p className="text-white">
                              You both earned <span className="font-bold" style={{color: '#fbbf24'}}>+10</span> points
                            </p>
                          )}
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <button onClick={resetTelepathy} className="btn-secondary py-3 font-bold">
                            Try Again
                          </button>
                          <button
                            onClick={() => {
                              resetTelepathy();
                              startSearching();
                            }}
                            className="btn-primary"
                          >
                            New Partner
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'chat' && (
                  <div className="bg-glass rounded-2xl border-glass chat-container">
                    <div className="p-4 border-b">
                      <h2 className="text-2xl font-bold text-white">Global Chat</h2>
                      <p className="text-primary text-sm">{onlineUsers.length} starseeds online</p>
                    </div>
                    
                    <div className="chat-messages">
                      {chatMessages.length === 0 && (
                        <div className="text-center text-primary py-8">
                          No messages yet. Start the conversation!
                        </div>
                      )}
                      {chatMessages.map((msg) => (
                        <div key={msg.id} className="chat-message">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-primary font-medium text-sm">{msg.user_name}</span>
                            <span style={{color: '#c4b5fd'}} className="text-xs">{new Date(msg.created_at).toLocaleTimeString()}</span>
                          </div>
                          <p className="text-white">{msg.content}</p>
                        </div>
                      ))}
                    </div>

                    <div className="p-4 border-t">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={newMessage}
                          onChange={(e) => setNewMessage(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                          placeholder="Share your message..."
                          style={{flex: 1}}
                        />
                        <button onClick={sendChatMessage} className="btn-primary px-6 py-3">
                          <Send style={{width: '1.25rem', height: '1.25rem'}} />
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {showCreateRitual && (
                <div className="modal-overlay" onClick={() => setShowCreateRitual(false)}>
                  <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-bold text-white mb-6">{t.rituals.modalTitle}</h2>
                    
                    <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                      <div>
                        <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.ritualName}</label>
                        <input
                          type="text"
                          value={newRitual.name}
                          onChange={(e) => setNewRitual({...newRitual, name: e.target.value})}
                          placeholder="e.g., Full Moon Meditation"
                        />
                      </div>

                      <div>
                        <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.description}</label>
                        <textarea
                          value={newRitual.description}
                          onChange={(e) => setNewRitual({...newRitual, description: e.target.value})}
                          placeholder="Describe the ritual..."
                          rows="3"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.type}</label>
                          <select value={newRitual.type} onChange={(e) => setNewRitual({...newRitual, type: e.target.value})}>
                            {ritualTypes.map(type => (
                              <option key={type.id} value={type.id}>{type.icon} {type.name}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.sacredNumber}</label>
                          <select value={newRitual.sacredNumber} onChange={(e) => setNewRitual({...newRitual, sacredNumber: parseInt(e.target.value)})}>
                            {sacredNumbers.map(num => (
                              <option key={num} value={num}>{num}</option>
                            ))}
                          </select>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.date}</label>
                          <input
                            type="date"
                            value={newRitual.date}
                            onChange={(e) => setNewRitual({...newRitual, date: e.target.value})}
                          />
                        </div>

                        <div>
                          <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.time}</label>
                          <input
                            type="time"
                            value={newRitual.time}
                            onChange={(e) => setNewRitual({...newRitual, time: e.target.value})}
                          />
                        </div>
                      </div>

                      <div>
                        <label className="text-white text-sm mb-2" style={{display: 'block'}}>{t.rituals.duration}</label>
                        <input
                          type="number"
                          value={newRitual.duration}
                          onChange={(e) => setNewRitual({...newRitual, duration: parseInt(e.target.value)})}
                          min="5"
                          max="180"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4 mt-4">
                        <button onClick={() => setShowCreateRitual(false)} className="btn-secondary w-full">
                          {t.rituals.cancel}
                        </button>
                        <button onClick={createRitual} className="btn-primary w-full">
                          {t.rituals.create}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(GlobalAwakeningPlatform));
    </script>
</body>
</html>
